# app/agents/strategist.py
import pdfplumber
import os
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain.prompts import PromptTemplate
from app.core.config import settings

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≠‡∏á (Gemini Model)
llm = ChatGoogleGenerativeAI(
    model="gemini-2.5-flash", # ‡πÉ‡∏ä‡πâ Flash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î
    google_api_key=settings.GOOGLE_API_KEY,
    temperature=0.3 # ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏û‡πâ‡∏≠‡πÄ‡∏à‡πâ‡∏≠
)

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (Read PDF)
def load_book_content(file_path):
    # ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ó‡∏ô (Test Mode)
    if not os.path.exists(file_path):
        print("‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF, ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ó‡∏ô...")
        return """
        ‡∏ã‡∏∏‡∏ô‡∏ß‡∏π‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ß‡πà‡∏≤: ‡∏Å‡∏≤‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏ê...
        ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠ '‡∏£‡∏π‡πâ‡πÄ‡∏Ç‡∏≤‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏≤ ‡∏£‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ä‡∏ô‡∏∞‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
        ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÄ‡∏Ç‡∏≤ ‡∏à‡∏∞‡∏ä‡∏ô‡∏∞‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏û‡πâ‡∏´‡∏ô‡∏∂‡πà‡∏á
        ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏≤ ‡∏à‡∏∞‡πÅ‡∏û‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ö.
        """
    
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
    print(f"üìñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡∏£‡∏≤‡∏à‡∏≤‡∏Å: {file_path}")
    text = ""
    with pdfplumber.open(file_path) as pdf:
        for page in pdf.pages:
            text += page.extract_text() + "\n"
    return text[:10000] # ‡∏ï‡∏±‡∏î‡∏°‡∏≤‡πÅ‡∏Ñ‡πà 10,000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö)

# 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å (Persona)
strategist_prompt = PromptTemplate(
    input_variables=["context"],
    template="""
    ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û‡∏ú‡∏π‡πâ‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ï‡∏≥‡∏£‡∏≤‡∏û‡∏¥‡∏ä‡∏±‡∏¢‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡∏ã‡∏∏‡∏ô‡∏ß‡∏π
    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ "‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å 3 ‡∏Ç‡πâ‡∏≠" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞‡∏®‡∏±‡∏ï‡∏£‡∏π
    
    ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡∏£‡∏≤:
    {context}
    
    ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á ‡∏î‡∏∏‡∏î‡∏±‡∏ô):
    """
)

# 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
def run_strategist():
    # Path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå PDF
    book_path = os.path.join(os.path.dirname(__file__), "../../data/sun_tzu.pdf")
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    content = load_book_content(book_path)
    chain = strategist_prompt | llm
    result = chain.invoke({"context": content})
    
    return result.content

# ‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
if __name__ == "__main__":
    print("--- ‚öîÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‚öîÔ∏è ---")
    analysis = run_strategist()
    print("\n[‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ó‡∏±‡∏û‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞]:")
    print(analysis)
    print("\n-------------------------------------")